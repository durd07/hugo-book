<script>
  const loadScript = (url, onloadFunction) => {
    var newScript = document.createElement("script");
    newScript.onerror = (oError) => {
      throw new URIError("The script " + oError.target.src + " didn't load correctly.");
    };
    if (onloadFunction) {newScript.onload = onloadFunction;}
    document.head.insertAdjacentElement('beforeend', newScript);
    newScript.src = url;
  }

  const loadPlantUMLOnNeed = () => {
    let plantumlPrefix = "language-plantuml";

    if (document.querySelectorAll("[class^=" + plantumlPrefix + "]").length > 0) {
      loadScript('https://cdn.jsdelivr.net/gh/jmnote/plantuml-encoder@1.2.4/dist/plantuml-encoder.min.js', () => {
        (function () {
          Array.prototype.forEach.call(document.querySelectorAll("[class^=" + plantumlPrefix + "]"), function (code) {
            let image = document.createElement("IMG");
            image.loading = 'lazy'; // Lazy loading
            image.src = 'http://www.plantuml.com/plantuml/svg/~1' + plantumlEncoder.encode(code.innerText);
            code.parentNode.insertBefore(image, code);
            code.style.display = 'none';
          });
        })();

        console.log("PlantUML init done");
      })
    }
  }

  window.addEventListener('load', function (event) {
    // load PlantUML
    loadPlantUMLOnNeed();
  })
</script>

<!-- Katex -->
{{ if or .Params.katex .Site.Params.katex }}
{{- if not (.Page.Scratch.Get "katex") -}}
<!-- Include katext only first time -->
<link rel="stylesheet" href="{{ "katex/katex.min.css" | relURL }}" />
<script defer src="{{ "katex/katex.min.js" | relURL }}"></script>
<script defer src="{{ "katex/auto-render.min.js" | relURL }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    let katexPrefix = "language-math";
    Array.prototype.forEach.call(document.querySelectorAll("[class^=" + katexPrefix + "]"), function (code) {
      let katex_p = document.createElement("p");
      katex_p.innerHTML = "$$" + code.innerText + "$$"
      code.parentElement.parentElement.replaceChild(katex_p, code.parentElement)
    });

    renderMathInElement(document.body, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\(", right: "\\)", display: false},
        {left: "\\[", right: "\\]", display: true}
      ]
    });
  });
</script>
{{- .Page.Scratch.Set "katex" true -}}
{{- end -}}
{{ end }}

<!--
<button style="position: fixed ! important; right: 0px; bottom: 0px;" onclick="toggleFullScreen()">Fullscreen</button>
<script>
  function toggleFullScreen() {
    document.getElementById("book-menu").classList.toggle('hidden');
    document.getElementById("book-toc").classList.toggle('hidden');
  }
</script>
-->
